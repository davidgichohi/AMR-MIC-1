<!DOCTYPE html>
<html>
<head>
  <title>MIC Interpreter</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 30px;
      background-color: #e6f0ff; /* Light bluish background */
    }
    h2 {
      text-align: center;
      color: #2b3990;
    }
    .selectors {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    select, input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #2b3990;
      border-radius: 3px;
      width: 160px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 2px solid #2b3990;
      background-color: #ffffff;
    }
    th, td {
      border: 1px solid #2b3990;
      text-align: center;
      padding: 10px;
    }
    th {
      background-color: #2b3990;
      color: white;
    }
    .buttons {
      display: flex;
      justify-content: space-evenly;
      margin-bottom: 30px;
    }
    button {
      background-color: #2b3990;
      color: white;
      border: none;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 3px;
    }
    button:hover {
      background-color: #1f2e6a;
    }
    .disclaimer {
      border: 2px solid #cc0000;
      background-color: #fff5f5;
      padding: 20px;
      border-radius: 15px;
      width: 90%;
      margin: auto;
      font-size: 14px;
      text-align: justify;
      color: #333;
    }
    .disclaimer b {
      display: block;
      text-align: center;
      color: #cc0000;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>MIC Interpreter</h2>

  <div class="selectors">
    <label>
      Organism<br>
      <select id="organism"></select>
    </label>
    <label>
      Sample<br>
      <select id="sampleType" disabled></select>
    </label>
  </div>

  <table id="micTable">
    <thead>
      <tr>
        <th>Antibiotics</th>
        <th>Class</th>
        <th>MIC Value</th>
        <th>Interpretation</th>
      </tr>
    </thead>
    <tbody id="micBody"></tbody>
  </table>

  <div class="buttons">
    <button onclick="clearForm()">New Organism</button>
    <button onclick="getClassification()">Result</button>
    <button onclick="goHome()">Home/Dashboard</button>
  </div>

  <div class="disclaimer">
    <b><h1>Disclaimer:</h1></b>
    This application's predictive artificial intelligence model is intended solely for informational purposes. The model's outputs are based on available data and underlying assumptions made during its design and development.
    <br><br>
    Users are strongly advised to exercise caution and avoid relying exclusively on the model’s predictions when making critical decisions. The outputs should be considered as one of multiple sources of information. It is recommended that users seek guidance from qualified experts or professionals to interpret and validate the model’s predictions in the context of their specific use case.
    <br><br>
    The developers, creators, and providers of this AI model disclaim any liability for decisions, actions, or outcomes arising from the use of the model’s predictions. Users are solely responsible for verifying and interpreting the outputs and are encouraged to exercise independent judgment and discretion when applying the results.
  </div>

  <script>
    let micData = {}, sampleMap = {}, classMap = {};

    async function loadData() {
      micData = (await axios.get('/api/mic_rules')).data;
      sampleMap = (await axios.get('/api/organism_sampletype')).data;
      classMap = (await axios.get('/api/antibiotic_classes')).data;

      let organisms = [...new Set(Object.keys(micData).map(k => k.split('|')[0]))];
      document.getElementById('organism').innerHTML = organisms.map(o => `<option>${o}</option>`).join('');
      populateSampleType();
      populateAntibiotics();
    }

    function populateSampleType() {
      const org = document.getElementById('organism').value;
      document.getElementById('sampleType').innerHTML = `<option>${sampleMap[org] || 'N/A'}</option>`;
    }

    function populateAntibiotics() {
      const org = document.getElementById('organism').value;
      const abxList = Object.keys(micData)
        .filter(k => k.startsWith(org + '|'))
        .map(k => k.split('|')[1]);

      const micBody = document.getElementById('micBody');
      micBody.innerHTML = '';

      abxList.forEach((abx, index) => {
        const abxClass = classMap[abx] || 'Other';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${abx}</td>
          <td>${abxClass}</td>
          <td><input type="number" id="mic-${index}" step="0.01"></td>
          <td id="result-${index}">-</td>
        `;
        micBody.appendChild(row);
      });
    }

    function getClassification() {
      const org = document.getElementById('organism').value;
      const abxList = Object.keys(micData)
        .filter(k => k.startsWith(org + '|'))
        .map(k => k.split('|')[1]);

      abxList.forEach((abx, index) => {
        const micInput = document.getElementById(`mic-${index}`);
        const resultCell = document.getElementById(`result-${index}`);

        if (!micInput.value) {
          resultCell.innerText = '-';
          return;
        }

        const mic = parseFloat(micInput.value);
        const rules = micData[`${org}|${abx}`];
        const result = rules.find(r => mic >= r.min && mic <= r.max);
        resultCell.innerText = result ? result.category : 'Value not defined by CLSI';
      });
    }

    function clearForm() {
      document.getElementById('micBody').querySelectorAll('input').forEach(i => i.value = '');
      document.getElementById('micBody').querySelectorAll('td[id^="result"]').forEach(c => c.innerText = '-');
    }

    function goHome() {
      alert("Redirecting to Dashboard (Placeholder)");
    }

    document.getElementById('organism').addEventListener('change', () => {
      populateSampleType();
      populateAntibiotics();
    });

    loadData();
  </script>
</body>
</html>
